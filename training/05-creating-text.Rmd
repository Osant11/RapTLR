# Creating Text with R {#creating-text}

In a clinical Top-Line Results Report, much of the narrative consists of sentences derived directly from analysis datasets: how many subjects were enrolled, what the demographic profile looked like, which adverse events were most frequent. Traditionally these numbers are read from tables and typed into a Word document by hand — a process that is slow, error-prone, and must be repeated every time the data changes.

RapTLR provides a set of text-generation functions that produce ready-to-insert narrative strings directly from your R datasets. Each function targets a specific, recurring reporting need:

- **`fct_smpl_rest()`** — report a subject count (with optional percentage) for any filtered population
- **`fct_var_text()`** — describe the distribution of a categorical variable as a formatted list
- **`fct_bsl_stats()`** — summarise a continuous baseline variable with central tendency and spread
- **`fct_mst_aes()`** — identify and describe the most common treatment-emergent adverse events

The outputs are plain character strings, so they slot directly into `textReplace()` to populate placeholders in your Word shell document. All examples in this chapter use the two built-in datasets:

```{r }
library(RapTLR)

data("tlr_adsl")   # Subject-level analysis dataset (ADSL) — 254 subjects
data("tlr_adae")   # Adverse events analysis dataset (ADAE)
```

---

```{r, include=FALSE}
knitr::opts_chunk$set(
  comment = "", echo = TRUE, collapse = TRUE
)
```

## `fct_smpl_rest()`

### Purpose

`fct_smpl_rest()` counts rows in a dataset and returns the result as a formatted character string. Two optional filter expressions can be chained: the first (`arg_fl_rest`) defines the reference population used as the denominator for percentage calculations, and the second (`arg_var_rest`) defines the subgroup to count as the numerator.

### Parameters

| Parameter | Type | Default | Description |
|---|---|---|---|
| `arg_dataset` | data frame | — | Dataset to filter and count |
| `arg_text_desc` | character | `""` | Text prepended before the count |
| `arg_text_end` | character | `""` | Text appended after the count |
| `arg_fl_rest` | expression | — | First filter — defines the denominator population |
| `arg_var_rest` | expression | — | Second filter — defines the subgroup to count |
| `arg_lbl` | character | `"nbr"` | Output format: `"nbr"`, `"pct"`, or `"nbr-pct"` |

### Examples

**Example 1 — Total number of subjects**

```{r}
fct_smpl_rest(arg_dataset = tlr_adsl)
```

**Example 2 — Count within a population flag**

```{r}
fct_smpl_rest(
  arg_dataset = tlr_adsl,
  arg_fl_rest = SAFFL == "Y"
)
```

**Example 3 — Embed the count in a sentence**

```{r}
fct_smpl_rest(
  arg_dataset   = tlr_adsl,
  arg_text_desc = "This study enrolled ",
  arg_text_end  = " participants in the safety population.",
  arg_fl_rest   = SAFFL == "Y"
)
```

**Example 4 — Subgroup count within a population**

The denominator is the safety population (254); the numerator is subjects assigned to Xanomeline High Dose (84).

```{r}
fct_smpl_rest(
  arg_dataset  = tlr_adsl,
  arg_fl_rest  = SAFFL == "Y",
  arg_var_rest = ARM == "Xanomeline High Dose"
)
```

**Example 5 — Return as a percentage**

```{r}
fct_smpl_rest(
  arg_dataset  = tlr_adsl,
  arg_fl_rest  = SAFFL == "Y",
  arg_var_rest = ARM == "Xanomeline High Dose",
  arg_lbl      = "pct"
)
```

**Example 6 — Return count and percentage together**

```{r}
fct_smpl_rest(
  arg_dataset  = tlr_adsl,
  arg_fl_rest  = SAFFL == "Y",
  arg_var_rest = ARM == "Xanomeline High Dose",
  arg_lbl      = "nbr-pct"
)
```

**Example 7 — Compound conditions and descriptive framing**

Filter arguments accept any logical expression, including compound conditions with `&`.

```{r}
fct_smpl_rest(
  arg_dataset   = tlr_adsl,
  arg_text_desc = "The study population included ",
  arg_text_end  = " female participants.",
  arg_fl_rest   = SEX == "F"
)
```

**Example 8 — Study completers at multiple time points**

Chain calls with `paste()` to build a multi-sentence summary.

```{r}
paste(
  fct_smpl_rest(
    arg_dataset   = tlr_adsl,
    arg_text_desc = "At week 8, the number of completers were: ",
    arg_fl_rest   = COMP8FL == "Y"
  ),
  fct_smpl_rest(
    arg_dataset   = tlr_adsl,
    arg_text_desc = "At week 16, the number of completers were: ",
    arg_fl_rest   = COMP16FL == "Y"
  ),
  fct_smpl_rest(
    arg_dataset   = tlr_adsl,
    arg_text_desc = "At week 24, the number of completers were: ",
    arg_fl_rest   = COMP24FL == "Y"
  ),
  sep = " "
)
```

---

## fct_var_text() {#var-text}

### Purpose

`fct_var_text()` creates a formatted text description of the distribution of a categorical variable. It counts how often each level appears, computes percentages, and returns a sentence listing the categories — connected with commas and "and" before the last item.

This is ideal for:

- Race and sex distributions in demographics sections
- Discontinuation reasons in disposition sections
- Any categorical variable where a compact ranked summary is needed

### Parameters

| Parameter | Type | Default | Description |
|---|---|---|---|
| `arg_text_desc` | character | `""` | Prefix text prepended to the output |
| `arg_dataset` | data frame | — | Dataset containing the variable |
| `arg_fl_rest` | expression | `NULL` | Optional filter applied before analysis |
| `arg_var_rest` | unquoted name | — | Categorical variable to analyse |
| `arg_order` | logical | `FALSE` | If `TRUE`, sort categories by descending frequency |
| `arg_cvt_stg` | function | `I` | Transformation applied to category labels (e.g., `str_to_sentence`) |
| `arg_nbr_obs` | numeric | `Inf` | Maximum number of categories to include |
| `arg_lbl` | character | `"pct"` | Format: `"nbr"`, `"pct"`, or `"nbr-pct"` |

### Examples

**Example 1 — Counts only**

```{r}
fct_var_text(
  arg_dataset  = tlr_adsl,
  arg_var_rest = RACE,
  arg_lbl      = "nbr"
)
```

**Example 2 — Percentages only (default)**

```{r}
fct_var_text(
  arg_dataset  = tlr_adsl,
  arg_var_rest = RACE,
  arg_lbl      = "pct"
)
```

**Example 3 — Counts and percentages combined**

```{r}
fct_var_text(
  arg_dataset  = tlr_adsl,
  arg_var_rest = RACE,
  arg_lbl      = "nbr-pct"
)
```

**Example 4 — Add a descriptive prefix**

```{r}
fct_var_text(
  arg_text_desc = "The study population comprised",
  arg_dataset   = tlr_adsl,
  arg_var_rest  = RACE,
  arg_lbl       = "pct"
)
```

**Example 5 — Convert labels to sentence case**

Raw dataset values are often uppercase. `arg_cvt_stg` applies any string-transformation function to the labels.

```{r}
fct_var_text(
  arg_text_desc = "The study population comprised",
  arg_dataset   = tlr_adsl,
  arg_var_rest  = RACE,
  arg_lbl       = "pct",
  arg_cvt_stg   = stringr::str_to_sentence
)
```

**Example 6 — Sort by frequency, most common and capitalised per words**

```{r}
fct_var_text(
  arg_dataset  = tlr_adsl,
  arg_var_rest = RACE,
  arg_lbl      = "pct",
  arg_order    = TRUE,
  arg_cvt_stg  = stringr::str_to_title
)
```

**Example 7 — Limit to top 2 categories and capitalized words**

Combine `arg_order = TRUE` with `arg_nbr_obs` to report only the most frequent categories.

```{r}
fct_var_text(
  arg_dataset  = tlr_adsl,
  arg_var_rest = RACE,
  arg_lbl      = "pct",
  arg_order    = TRUE,
  arg_nbr_obs  = 2,
  arg_cvt_stg  = stringr::str_to_title
)
```

**Example 8 — Filter to a specific population first and first word capitalized**

Percentages are computed within the filtered population. Here the safety flag makes no difference since all subjects have `SAFFL == "Y"`, but the pattern is useful when subsets differ.

```{r}
fct_var_text(
  arg_text_desc = "Among the safety population, most were",
  arg_dataset   = tlr_adsl,
  arg_fl_rest   = SAFFL == "Y",
  arg_var_rest  = RACE,
  arg_lbl       = "pct",
  arg_order     = TRUE,
  arg_nbr_obs   = 3,
  arg_cvt_stg   = stringr::str_to_sentence
)
```

**Example 9 — Discontinuation reasons (complete example)**

```{r}
fct_var_text(
  arg_text_desc = "The most common reasons for treatment discontinuation were:",
  arg_dataset   = tlr_adsl,
  arg_fl_rest   = DISCONFL == "Y",
  arg_var_rest  = DCREASCD,
  arg_order     = TRUE,
  arg_nbr_obs   = 3,
  arg_cvt_stg   = stringr::str_to_lower,
  arg_lbl       = "nbr-pct"
)
```

---

## fct_bsl_stats() {#bsl-stats}

`fct_bsl_stats()` generates a formatted text summary of a continuous numeric variable at baseline. It calculates a measure of central tendency (mean or median) together with a measure of dispersion (standard deviation or range), both overall and optionally per treatment arm.

| Parameter | Type | Default | Description |
|---|---|---|---|
| `arg_dataset` | data frame | — | Dataset containing the numeric variable |
| `arg_grp` | unquoted name | — | Grouping variable (e.g., `ARM`, `TRT01A`) |
| `arg_trt_inc` | character vector | `NULL` | Treatment groups for the per-arm breakdown; `NULL` = overall total only |
| `arg_var_num` | unquoted name | — | Numeric variable to summarise (e.g., `AGE`, `WEIGHTBL`) |
| `arg_var1` | character | `"mean"` | Central tendency: `"mean"` or `"median"` |
| `arg_var2` | character | `"sd"` | Dispersion: `"sd"` (standard deviation) or `"range"` (min, max) |
| `arg_unit` | character | `""` | Unit appended to each value (e.g., `"years"`, `"kg"`) |
| `arg_label` | character | `""` | Variable description used in the output sentence |
| `arg_cvt_stg` | function | `I` | Transformation applied to sentence connectors |

**Example 1 — Overall mean age with standard deviation**

Without `arg_trt_inc`, only the total across all arms is reported.

```{r}
fct_bsl_stats(
  arg_dataset = tlr_adsl,
  arg_grp     = ARM,
  arg_var_num = AGE,
  arg_var1    = "mean",
  arg_var2    = "sd",
  arg_unit    = "years",
  arg_label   = "age"
)
```

**Example 2 — Overall median age with range**

```{r}
fct_bsl_stats(
  arg_dataset = tlr_adsl,
  arg_grp     = ARM,
  arg_var_num = AGE,
  arg_var1    = "median",
  arg_var2    = "range",
  arg_unit    = "years",
  arg_label   = "age"
)
```

**Example 3 — Mean age broken down by treatment arm**

Pass the arm names to `arg_trt_inc` to append per-arm statistics after the overall total.

```{r}
fct_bsl_stats(
  arg_dataset = tlr_adsl,
  arg_grp     = ARM,
  arg_trt_inc = c("Placebo", "Xanomeline Low Dose", "Xanomeline High Dose"),
  arg_var_num = AGE,
  arg_var1    = "mean",
  arg_var2    = "sd",
  arg_unit    = "years",
  arg_label   = "age"
)
```

**Example 4 — Median baseline weight with range by arm**

```{r}
fct_bsl_stats(
  arg_dataset = tlr_adsl,
  arg_grp     = ARM,
  arg_trt_inc = c("Placebo", "Xanomeline Low Dose", "Xanomeline High Dose"),
  arg_var_num = WEIGHTBL,
  arg_var1    = "median",
  arg_var2    = "range",
  arg_unit    = "kg",
  arg_label   = "baseline weight"
)
```

**Example 5 — Mean baseline BMI using `TRT01A` as the grouping variable**

Any treatment variable present in the dataset can serve as `arg_grp`.

```{r }
fct_bsl_stats(
  arg_dataset = tlr_adsl,
  arg_grp     = TRT01A,
  arg_trt_inc = c("Xanomeline High Dose", "Xanomeline Low Dose", "Placebo"),
  arg_var_num = BMIBL,
  arg_var1    = "mean",
  arg_var2    = "sd",
  arg_unit    = "kg/m²",
  arg_label   = "baseline BMI",
  arg_cvt_stg = stringr::str_to_lower
)
```

**Example 6 — Combine two baseline variables into one sentence**

The `%c&%` operator (from `cust_opr.R`) joins strings with " and ", making it easy to chain multiple `fct_bsl_stats()` calls.

```{r }

fct_bsl_stats(
    arg_dataset = tlr_adsl,
    arg_grp     = ARM,
    arg_var_num = AGE,
    arg_var1    = "median",
    arg_var2    = "range",
    arg_unit    = "years",
    arg_label   = "age"
) %c&%
fct_bsl_stats(
    arg_dataset = tlr_adsl,
    arg_grp     = ARM,
    arg_trt_inc = c("Xanomeline High Dose", "Xanomeline Low Dose", "Placebo"),
    arg_var_num = BMIBL,
    arg_var1    = "mean",
    arg_var2    = "sd",
    arg_unit    = "kg/m²",
    arg_label   = "baseline BMI",
    arg_cvt_stg = stringr::str_to_lower
)
```

---

## fct_mst_aes() {#mst-aes}

### Purpose

`fct_mst_aes()` identifies the most common treatment-emergent adverse events (TEAEs) in a specified treatment group and returns a formatted sentence listing each event with its frequency across all groups.

The function works by:

1. Merging the AE dataset with the subject-level dataset on `USUBJID`
2. Counting distinct subjects with each event per treatment group
3. Computing frequency as a percentage of each group's population
4. Filtering to events that meet or exceed the threshold in the target arm
5. Returning a publication-ready sentence with all frequencies

### Parameters

| Parameter | Type | Default | Description |
|---|---|---|---|
| `arg_data` | data frame | — | Adverse event dataset (e.g., `tlr_adae`); must include `USUBJID` |
| `arg_data_adsl` | data frame | — | Subject-level dataset (e.g., `tlr_adsl`); must include `USUBJID` and the grouping variable |
| `arg_grp` | unquoted name | — | Treatment group variable (e.g., `ARM`, `TRT01A`) |
| `arg_var` | unquoted name | — | AE variable to analyse (`AEDECOD` for preferred term, `AEBODSYS` for SOC) |
| `arg_trt_flt` | unquoted name | — | Treatment arm used as the frequency threshold reference (use backticks if the name contains spaces) |
| `arg_frq` | numeric | `15` | Minimum frequency (%) in `arg_trt_flt` for an event to be included |
| `arg_freq_num` | logical | `TRUE` | If `TRUE`, frequencies are returned as numbers |
| `arg_rounding` | numeric | `1` | Number of decimal places |

### Examples

**Example 1 — Most common AEs (≥15%) by preferred term in the Xanomeline High Dose arm**

```{r}
fct_mst_aes(
  arg_data      = tlr_adae,
  arg_data_adsl = tlr_adsl,
  arg_grp       = ARM,
  arg_var       = AEDECOD,
  arg_trt_flt   = `Xanomeline High Dose`
)
```

**Example 2 — Lower frequency threshold to include more events**

```{r}
fct_mst_aes(
  arg_data      = tlr_adae,
  arg_data_adsl = tlr_adsl,
  arg_grp       = ARM,
  arg_var       = AEDECOD,
  arg_trt_flt   = `Xanomeline High Dose`,
  arg_frq       = 10
)
```

**Example 3 — Higher threshold with two decimal places**

```{r}
fct_mst_aes(
  arg_data      = tlr_adae,
  arg_data_adsl = tlr_adsl,
  arg_grp       = ARM,
  arg_var       = AEDECOD,
  arg_trt_flt   = `Xanomeline High Dose`,
  arg_frq       = 20,
  arg_rounding  = 2
)
```

**Example 4 — Summarise by system organ class (SOC)**

Replace `AEDECOD` with `AEBODSYS` for a higher-level safety overview. This is the call used in the standard RapTLR demo.

```{r}
fct_mst_aes(
  arg_data      = tlr_adae,
  arg_data_adsl = tlr_adsl,
  arg_grp       = ARM,
  arg_var       = AEBODSYS,
  arg_trt_flt   = `Xanomeline High Dose`,
  arg_frq       = 15
)
```

**Example 5 — Use `TRT01A` as the grouping variable**

```{r}
fct_mst_aes(
  arg_data      = tlr_adae,
  arg_data_adsl = tlr_adsl,
  arg_grp       = TRT01A,
  arg_var       = AEDECOD,
  arg_trt_flt   = `Xanomeline High Dose`,
  arg_frq       = 15,
  arg_rounding  = 2
)
```

**Example 6 — Complete safety paragraph**

Combine `fct_mst_aes()` with `fct_smpl_rest()` using the `%c%` operator (space-join) to build a full safety narrative sentence.

```{r}
fct_smpl_rest(
    arg_dataset   = tlr_adsl,
    arg_text_desc = "A total of ",
    arg_text_end  = " subjects were included in the safety population.",
    arg_fl_rest   = SAFFL == "Y"
) %c%
fct_mst_aes(
    arg_data      = tlr_adae,
    arg_data_adsl = tlr_adsl,
    arg_grp       = ARM,
    arg_var       = AEBODSYS,
    arg_trt_flt   = `Xanomeline High Dose`,
    arg_frq       = 15
)
```
