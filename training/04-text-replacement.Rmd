# Dynamic Text Replacement {#text-replacement}

## The textReplace() Function

The package provides also a function to replace placeholders in a .docx document with R values.

## Why using textReplace() Function?

Traditional approach: - Run analysis in R - Manually copy numbers into Word - Data changes → manually update all numbers

**RapTLR approach:** - Write shell with placeholders - Calculate values in R - Automatically replace all placeholders - Data changes → re-run script, done!

## Function Parameters

### Required Parameters

**doc_object**: Can be either a string or officer object. If string, a path where the .docx is saved. If officer object, should be the .docx loaded by officer::read_docx().

**keyword**: Placeholders in the document to be replaced.

**replacement**: Text that needs to be inserted at the keyword position.

### Optional Parameters

**return_to_file**: Path and name to save the modified document. If NULL, it is saving a new .docx in the current working directory called `TLR_updated.docx`.

## Basic Usage

We provided a dummy .docx documents with placeholders that can be used for practicing. It can be downloaded [here](https://github.com/johnsonandjohnson/RapTLR/blob/main/inst/extdata/Keywords_replace.docx).

The following code can be used to access it after installing the package.

```{r eval=FALSE}
imported_docx <- system.file( "extdata", "Keywords_replace.docx", package = "RapTLR" )
```

Within this document there are three placeholders, `TTsubjectTT`, `TTsiteTT`, `TTconclusionTT` and each of these placeholders can be replaced with R values using the `textReplace()` function:

```{r eval=FALSE}
library(RapTLR)

imported_docx <- system.file( "extdata", "Keywords_replace.docx", package = "RapTLR" )

TTsubjectTT <- "There were 250 randomized subjects."
TTsiteTT <- "There were 15 different sites."
TTconclusionTT <- "The study succeeded."

new_doc <- textReplace(
  doc_object = imported_docx,
  keyword = "TTsubjectTT",
  replacement = TTsubjectTT
)

new_doc <- textReplace(
  doc_object = new_doc,
  keyword = "TTsiteTT",
  replacement = TTsiteTT
)

new_doc <- textReplace(
  doc_object = new_doc,
  keyword = "TTconclusionTT",
  replacement = TTconclusionTT
)

```

Notice that the original .docx document is called only the first time and the updated document is saved in R as `new_doc` and is automatically saved as `TLR_updated.docx` in the current working directory.\
For the two others placeholders, the update is made directly on `new_doc` and save again as `new_doc` and as `TLR_updated.docx`.

## Chaining Multiple Replacements

Instead of calling the object multiple times, it is also possible to create a chain or pipe.

### Method 1: Base R Pipe

```{r eval=FALSE}
library(RapTLR)

imported_docx <- system.file( "extdata", "Keywords_replace.docx", package = "RapTLR" )

TTsubjectTT <- "There were 250 randomized subjects."
TTsiteTT <- "There were 15 different sites."
TTconclusionTT <- "The study succeeded."

textReplace(
  doc_object = imported_docx,
  keyword = "TTsubjectTT",
  replacement = TTsubjectTT
) |>
textReplace(
  keyword = "TTsiteTT",
  replacement = TTsiteTT
) |>
textReplace(
  keyword = "TTconclusionTT",
  replacement = TTconclusionTT,
  return_to_file = "TLR_final.docx"
)
```

### Method 2: magrittr Pipe

```{r eval=FALSE}
library(RapTLR)
library(magrittr)

imported_docx <- system.file( "extdata", "Keywords_replace.docx", package = "RapTLR" )

TTsubjectTT <- "There were 250 randomized subjects."
TTsiteTT <- "There were 15 different sites."
TTconclusionTT <- "The study succeeded."

textReplace(
  doc_object = imported_docx,
  keyword = "TTsubjectTT",
  replacement = TTsubjectTT
) %>% 
textReplace(
  keyword = "TTsiteTT",
  replacement = TTsiteTT
) %>% 
textReplace(
  keyword = "TTconclusionTT",
  replacement = TTconclusionTT,
  return_to_file = "TLR_final.docx"
)
```

## Practical Examples

In the package, we have also provided two dummy ADaM datasets (`tlr_adsl`, `tlr_adae`) that can be loaded in the R session with the function `data(...)`.  
In the below examples we are using only `tlr_adsl` but we will use `tlr_adae` in the next chapter. 

### Example 1: Population Counts

```{r eval=FALSE}
library(RapTLR) 

data("tlr_adsl")

n_enrolled <- nrow(tlr_adsl)
n_safety <- sum(tlr_adsl$SAFFL == "Y")
n_efficacy <- sum(tlr_adsl$EFFFL == "Y")

pop_text <- sprintf(
  "A total of %d participants were enrolled. The safety population included %d participants and the efficacy population included %d participants.",
  n_enrolled, n_safety, n_efficacy
)

imported_docx <- system.file( "extdata", "Keywords_replace.docx", package = "RapTLR" )

textReplace(
  doc_object = imported_docx,
  keyword = "TTsubjectTT",
  replacement = TTsubjectTT, 
  return_to_file = "TLR_updated.docx"
)
```

### Example 2: Efficacy Results

```{r eval=FALSE}
response_rate_trt <- 0.45
response_rate_pbo <- 0.30

efficacy_text <- sprintf(
  "The response rate was %.1f%% in treatment vs %.1f%% in placebo.",
  response_rate_trt * 100,
  response_rate_pbo * 100
)

imported_docx <- system.file( "extdata", "Keywords_replace.docx", package = "RapTLR" )

textReplace(
  doc_object = imported_docx,
  keyword = "TTconclusionTT",
  replacement = efficacy_text, 
  return_to_file = "TLR_updated.docx"
)
```

## Complete Workflow Example

```{r eval=FALSE}
library(RapTLR)
library(magrittr)

data("tlr_adsl")

# Subjects
n_enrolled <- nrow(tlr_adsl)
n_safety <- sum(tlr_adsl$SAFFL == "Y")
n_efficacy <- sum(tlr_adsl$EFFFL == "Y")

pop_text <- sprintf(
  "A total of %d participants were enrolled. The safety population included %d participants and the efficacy population included %d participants.",
  n_enrolled, n_safety, n_efficacy
)

# Sites
n_site <- length(unique(tlr_adsl$SITEID))

site_text <- sprintf( 
  "In total there were %d sites recruited"
)


# Efficacy
response_rate_trt <- 0.45
response_rate_pbo <- 0.30

efficacy_text <- sprintf(
  "The response rate was %.1f%% in treatment vs %.1f%% in placebo.",
  response_rate_trt * 100,
  response_rate_pbo * 100
)

# Docx document
imported_docx <- system.file( "extdata", "Keywords_replace.docx", package = "RapTLR" )

# Replacing placeholders
textReplace(
  doc_object = imported_docx,
  keyword = "TTsubjectTT",
  replacement = pop_text
) %>% 
textReplace(
  keyword = "TTsiteTT", 
  replacement = site_text
) %>% 
textReplace(
  keyword = "TTconclusionTT",
  replacement = efficacy_text, 
  return_to_file = "TLR_updated.docx"
)
```